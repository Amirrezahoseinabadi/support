<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پشتیبانی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #302B5A; color: #E0E0E0; }
        .nav-bar { background-color: #FFFFFF; color: #302B5A; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-button { transition: all 0.2s ease-in-out; }
        .nav-button.active { color: #7C3AED; transform: scale(1.1); }
        .form-input, .form-select, .form-textarea { background-color: transparent; border: 1px solid #9A94C0; color: #FFFFFF; border-radius: 0.5rem; padding: 0.75rem; width: 100%; font-size: 0.9rem; }
        .form-input::placeholder, .form-textarea::placeholder { color: #9A94C0; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #A78BFA; }
        .btn-primary { background-color: #7C3AED; color: white; padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        .btn-primary:disabled { background-color: #5b21b6; cursor: not-allowed; }
        .btn-secondary { background-color: transparent; border: 1px solid #9A94C0; color: #E0E0E0; padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 500; font-size: 0.9rem; }
    </style>
</head>
<body class="flex flex-col h-screen">
    <div id="loading-view" class="flex flex-col items-center justify-center h-full text-center p-4">
        <div id="loading-spinner">
            <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
             <p class="mt-4 text-white text-sm">در حال احراز هویت...</p>
        </div>
    </div>

    <div id="main-app-container" class="hidden h-full flex flex-col">
        <main id="app-container" class="flex-grow overflow-y-auto">
            <header class="p-4 text-center text-white text-lg font-bold shadow-md" style="background-color: #3E386B;">
                <h1 id="header-title">تیکت‌ها</h1>
            </header>
            <div id="new-ticket-view" class="p-4 hidden">
                <form id="new-ticket-form" class="space-y-4">
                    <div><label for="department" class="block mb-2 text-sm font-medium">دپارتمان</label><select id="department" name="department" class="form-select"><option value="general">سوالات متفرقه</option><option value="technical">پشتیبانی فنی</option><option value="sales">بخش فروش</option></select></div>
                    <div><label for="subject" class="block mb-2 text-sm font-medium">موضوع</label><input type="text" id="subject" name="subject" class="form-input" placeholder="موضوع تیکت خود را وارد کنید" required></div>
                    <div><label for="message" class="block mb-2 text-sm font-medium">متن پیام</label><textarea id="message" name="message" rows="6" class="form-textarea" placeholder="مشکل یا سوال خود را با جزئیات کامل بنویسید..." required></textarea></div>
                    <div class="flex justify-between items-center pt-2">
                        <button type="button" id="submit-new-ticket-btn" class="btn-primary">ارسال</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyB7sMBYNZT0Brk411-vNUy1JE_BV6gXsXo",
            authDomain: "support-bot-app.firebaseapp.com",
            projectId: "support-bot-app",
            storageBucket: "support-bot-app.appspot.com",
            messagingSenderId: "444176603708",
            appId: "1:444176603708:web:a3b5938737a8752b824139",
            measurementId: "G-MWZ1PSNVVV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let telegramUserId = null;

        const loadingView = document.getElementById('loading-view');
        const mainAppContainer = document.getElementById('main-app-container');
        const submitNewTicketBtn = document.getElementById('submit-new-ticket-btn');

        function startApp(userId) {
            telegramUserId = userId;
            loadingView.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const tg = window.Telegram.WebApp;
                tg.ready();
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    startApp(tg.initDataUnsafe.user.id.toString());
                } else {
                    startApp("12345-test-user"); // For testing in browser
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }
        });

        submitNewTicketBtn.addEventListener('click', async () => {
            const subject = document.getElementById('subject').value.trim();
            const message = document.getElementById('message').value.trim();
            const department = document.getElementById('department').value;

            if (!subject || !message) {
                alert("لطفا تمام فیلدها را پر کنید.");
                return;
            }

            try {
                const ticketDocRef = await addDoc(collection(db, 'tickets'), { 
                    telegramId: telegramUserId, 
                    subject: subject, 
                    department: department, 
                    status: 'open', 
                    createdAt: serverTimestamp(), 
                    updatedAt: serverTimestamp() 
                });

                await addDoc(collection(db, 'tickets', ticketDocRef.id, 'messages'), { 
                    sender: 'user', 
                    text: message, 
                    timestamp: serverTimestamp() 
                });

                alert("تیکت شما با موفقیت ثبت شد.");
                document.getElementById('new-ticket-form').reset();

            } catch (error) {
                console.error("Error creating new ticket: ", error);
                alert("خطا در ایجاد تیکت.");
            }
        });
    </script>
</body>
</html>
