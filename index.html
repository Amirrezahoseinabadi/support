<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- Emoji Picker Library -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* New Color Palette Inspired by Logo */
            --brand-dark-blue: #1A2E40;
            --brand-light-blue: #0091D5;
            --brand-secondary-bg: #274059;
            --brand-text-primary: #FFFFFF;
            --brand-text-secondary: #B0C4DE;
            --brand-user-message: #005A8D;
            --brand-admin-message: #3D5A80;
        }
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: var(--brand-dark-blue); 
            color: var(--brand-text-primary); 
            overflow: hidden; 
        }
        .nav-bar { 
            background-color: var(--brand-secondary-bg); 
            color: var(--brand-text-primary); 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2); 
        }
        .nav-button.active { color: var(--brand-light-blue); }
        .form-input, .form-select, .form-textarea { 
            background-color: transparent; 
            border: 1px solid var(--brand-text-secondary); 
            color: var(--brand-text-primary); 
            border-radius: 0.5rem; 
            padding: 0.75rem; 
            width: 100%; 
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--brand-light-blue);
        }
        
        /* New Chat Styles */
        #conversation-container {
            background-color: #0e1621;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: 300px;
        }
        .message-bubble {
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            width: fit-content;
            word-wrap: break-word;
        }
        .message-user {
            background-color: var(--brand-user-message);
            color: white;
            border-bottom-right-radius: 4px; /* Tail points outwards (right) */
        }
        .message-admin {
            background-color: var(--brand-admin-message);
            color: white;
            border-bottom-left-radius: 4px; /* Tail points outwards (left) */
        }
        .sender-name {
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 4px;
            padding: 0 8px;
        }
        .message-time {
            font-size: 0.7rem;
            color: var(--brand-text-secondary);
            margin-top: 2px;
        }
        #conversation-view.is-open { transform: translateX(0%); }

        /* Reply box styles */
        #reply-box {
            background-color: var(--brand-secondary-bg);
        }
        #reply-message {
            background-color: var(--brand-dark-blue);
            border-radius: 20px;
            border: none;
            padding: 10px 16px;
            color: var(--brand-text-primary);
            max-height: 100px;
            resize: none;
        }
        #reply-message:focus {
            outline: none;
        }
        .icon-button {
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .icon-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Glassmorphism Modal Style */
        .glass-modal-content {
            background: rgba(39, 64, 89, 0.6); /* --brand-secondary-bg with opacity */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        /* Emoji Picker Style */
        #emoji-picker-container emoji-picker {
            --background: var(--brand-secondary-bg);
            --border-color: var(--brand-dark-blue);
            --text-color: var(--brand-text-primary);
            --secondary-text-color: var(--brand-text-secondary);
        }

        /* Rating Stars Style - CORRECTED */
        .rating-stars {
            direction: ltr; 
        }
        .rating-star {
            cursor: pointer;
            color: #6b7280; 
            transition: color 0.2s;
        }
        .rating-stars:hover .rating-star {
            color: #f59e0b;
        }
        .rating-stars .rating-star:hover ~ .rating-star {
            color: #6b7280;
        }
        .rating-stars[data-rated="true"] .rating-star {
            cursor: default;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <input type="file" id="file-upload" class="hidden" accept="image/*">

    <div id="loading-view" class="flex flex-col items-center justify-center h-full text-center p-4">
        <svg class="animate-spin h-10 w-10 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p class="mt-4 text-white text-sm">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª...</p>
    </div>

    <div id="main-app-container" class="hidden h-full flex-col relative w-full">
        <div id="main-content" class="flex-grow flex flex-col">
            <header class="p-4 text-center text-white text-lg font-bold shadow-md sticky top-0 z-10" style="background-color: var(--brand-secondary-bg);">
                <h1 id="header-title">ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</h1>
            </header>
            <main id="app-container" class="flex-grow overflow-y-auto">
                <div id="tickets-list-view" class="p-4">
                    <div id="tickets-container" class="space-y-3"></div>
                    <div id="no-tickets-message" class="hidden text-center text-gray-400 mt-16">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                        <p class="mt-4 text-lg">ØªÛŒÚ©Øª Ù†Ø¯Ø§Ø±ÛŒØ¯!</p>
                    </div>
                </div>
                <div id="new-ticket-view" class="p-4 hidden">
                    <form id="new-ticket-form" class="space-y-4">
                        <div>
                            <label for="department" class="block mb-2 text-sm font-medium">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†</label>
                            <select id="department" name="department" class="form-select">
                                <option value="general">Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªÙØ±Ù‚Ù‡</option>
                                <option value="technical">ÙˆØ§Ø­Ø¯ ÙÙ†ÛŒ</option>
                                <option value="sales">ÙˆØ§Ø­Ø¯ ÙØ±ÙˆØ´</option>
                                <option value="marketing">ÙˆØ§Ø­Ø¯ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ</option>
                                <option value="ideas">Ø§ÛŒØ¯Ù‡ Ù‡Ø§ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª</option>
                            </select>
                        </div>
                        <div><label for="subject" class="block mb-2 text-sm font-medium">Ù…ÙˆØ¶ÙˆØ¹</label><input type="text" id="subject" name="subject" class="form-input" placeholder="Ù…ÙˆØ¶ÙˆØ¹ ØªÛŒÚ©Øª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" required></div>
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label for="message" class="block text-sm font-medium">Ù…ØªÙ† Ù¾ÛŒØ§Ù…</label>
                                <button type="button" id="ai-enhance-btn" class="flex items-center text-xs px-2 py-1 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--brand-admin-message); color: var(--brand-text-secondary);">
                                    <svg id="ai-enhance-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                    <svg id="ai-enhance-spinner" class="animate-spin h-4 w-4 ml-1 hidden" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    <span>Ø¨Ù‡Ø¨ÙˆØ¯ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</span>
                                </button>
                            </div>
                            <textarea id="message" name="message" rows="6" class="form-textarea" placeholder="Ù…Ø´Ú©Ù„ ÛŒØ§ Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." required></textarea>
                        </div>
                        <!-- AI Suggestion Box -->
                        <div id="ai-suggestion-box" class="hidden p-3 mt-2 rounded-lg" style="background-color: var(--brand-secondary-bg); border: 1px solid var(--brand-admin-message);">
                            <h4 class="text-sm font-bold text-white mb-2">âœ¨ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</h4>
                            <div class="mb-3">
                                <label class="block text-xs text-gray-400 mb-1">Ù…ÙˆØ¶ÙˆØ¹ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:</label>
                                <p id="ai-suggested-subject" class="text-sm p-2 rounded" style="background-color: var(--brand-dark-blue);"></p>
                            </div>
                            <div class="mb-4">
                                <label class="block text-xs text-gray-400 mb-1">Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø¨Ù‡Ø¨ÙˆØ¯ÛŒØ§ÙØªÙ‡:</label>
                                <p id="ai-improved-message" class="text-sm p-2 rounded whitespace-pre-wrap max-h-40 overflow-y-auto" style="background-color: var(--brand-dark-blue);"></p>
                            </div>
                            <div class="flex justify-end space-x-2 space-x-reverse">
                                <button type="button" id="ai-apply-btn" class="text-xs text-white px-3 py-1.5 rounded-md" style="background-color: var(--brand-light-blue);">Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ù…ØªÙ†</button>
                                <button type="button" id="ai-discard-btn" class="text-xs px-3 py-1.5 rounded-md" style="background-color: var(--brand-admin-message);">Ù„ØºÙˆ</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                            <button type="button" id="submit-new-ticket-btn" class="text-white px-4 py-2 rounded-md w-full disabled:opacity-50" style="background-color: var(--brand-light-blue);">Ø§Ø±Ø³Ø§Ù„</button>
                        </div>
                    </form>
                </div>
            </main>
            <!-- Navigation bar updated: text removed, buttons take up half width each -->
            <nav id="main-nav" class="nav-bar h-[80px] flex items-center justify-around">
                <button id="nav-tickets-list" class="nav-button active flex flex-col items-center space-y-1 w-1/2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg><span class="text-xs">ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</span></button>
                <button id="nav-new-ticket" class="nav-button flex flex-col items-center space-y-1 w-1/2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span class="text-xs">ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯</span></button>
            </nav>
        </div>

        <div id="conversation-view" class="absolute top-0 right-0 w-full h-full flex-col transform translate-x-full transition-transform duration-300 ease-in-out z-20 hidden">
             <header class="p-3 flex items-center sticky top-0 z-10" style="background-color: var(--brand-secondary-bg);">
                <button id="back-to-tickets" class="p-2 rounded-full transform rotate-180"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg></button>
                <h2 id="conversation-header" class="text-white font-bold mr-2">Ú¯ÙØªÚ¯Ùˆ</h2>
             </header>
            <div id="conversation-container" class="p-4 space-y-2 flex flex-col flex-grow overflow-y-auto"></div>
            <div id="emoji-picker-container" class="absolute bottom-[70px] right-2 z-30 hidden">
                <emoji-picker></emoji-picker>
            </div>
             <div id="reply-box" class="p-2 sticky bottom-0 border-t" style="border-color: var(--brand-dark-blue);">
                <form id="reply-form" class="flex items-center space-x-2 space-x-reverse">
                    <button type="button" id="attach-file-btn" class="icon-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
                    </button>
                    <textarea id="reply-message" rows="1" class="flex-grow" placeholder="Ù¾Ø§Ø³Ø®..." required></textarea>
                    <button type="button" id="emoji-btn" class="icon-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </button>
                    <button type="submit" class="icon-button text-white" style="background-color: var(--brand-light-blue);">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="glass-modal-content p-6 w-full max-w-md flex flex-col max-h-[90vh]">
            <h3 class="text-xl font-bold mb-4 text-white text-center">â—ï¸ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª</h3>
            <div class="overflow-y-auto pr-2 space-y-4 text-sm text-[var(--brand-text-secondary)]">
                <div>
                    <h4 class="font-bold text-white mb-2">ğŸ’¡ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª:</h4>
                    <p>Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ <a href="https://faqhub.amiruserbot7.workers.dev/" target="_blank" class="text-blue-300 hover:underline">ØµÙØ­Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„</a> Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯. Ø´Ø§ÛŒØ¯ Ù¾Ø§Ø³Ø® Ø³ÙˆØ§Ù„ Ø´Ù…Ø§ Ø¢Ù†Ø¬Ø§ Ø¨Ø§Ø´Ø¯!</p>
                </div>
                <div>
                    <h4 class="font-bold text-white mb-2">ğŸ“‹ Ù†Ù…ÙˆÙ†Ù‡ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª:</h4>
                    <div class="p-3 rounded-lg text-xs" style="background-color: var(--brand-dark-blue);">
                        <p class="whitespace-pre-wrap">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†: (Ù†Ø³Ø¨Øª Ø¨Ù‡ Ù…ÙˆØ¶ÙˆØ¹ ØªÛŒÚ©Øª ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆØ¯)
Ù…ÙˆØ¶ÙˆØ¹: Ø¹Ø¯Ù… Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø³ÙˆØ±Ø¯ Ù¾Ù†Ù„
Ø³Ù„Ø§Ù… Ùˆ ÙˆÙ‚Øª Ø¨Ø®ÛŒØ±ØŒ Ø¨Ù†Ø¯Ù‡ Ø¯Ø± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆÛŒØ³ Ø§Ù…Ú©Ø§Ù† ØªØºÛŒÛŒØ±/Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø³ÙˆØ±Ø¯ Ù¾Ù†Ù„Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±Ù….
Ù„Ø·ÙØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø§Ø±Ù… Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø±ÙØ¹ Ø¨ÙØ±Ù…Ø§ÛŒÛŒØ¯.</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-white/10">
                <button id="info-modal-close-btn" class="text-white px-6 py-2.5 rounded-md w-full transition" style="background-color: var(--brand-light-blue);">Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…</button>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div class="bg-[var(--brand-secondary-bg)] rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <div id="modal-icon" class="mx-auto mb-4"></div>
            <h3 id="modal-title" class="text-lg font-bold mb-2 text-white"></h3>
            <p id="modal-message" class="text-[var(--brand-text-secondary)] mb-6"></p>
            <button id="modal-close-btn" class="text-white px-6 py-2 rounded-md w-full" style="background-color: var(--brand-light-blue);">Ø¨Ø§Ø´Ù‡</button>
        </div>
    </div>
    
    <div id="notification-toast" class="fixed top-5 right-5 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

    <script>
        const WORKER_URL = 'https://support-api-worker.amiruserbot7.workers.dev';
        const firebaseConfig = {
            apiKey: "AIzaSyAjBkdCe-kJK2VFfM3lSFyFiFNXElOCPSg",
            authDomain: "support-app-final.firebaseapp.com",
            databaseURL: "https://support-app-final-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "support-app-final",
            storageBucket: "support-app-final.appspot.com",
            messagingSenderId: "220983533006",
            appId: "1:220983533006:web:87f404486afb9f6a06df9f"
        };
        
        // --- AI ENHANCEMENT CONSTANTS ---
        const GPT_API_KEY = '7135477742:xpbZ0YO92loHaRu@Api_ManagerRoBot'; 
        const AI_ENHANCE_ENDPOINT = '/enhance'; 

        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();

        let telegramUserId = null;
        let telegramUserName = 'Ú©Ø§Ø±Ø¨Ø±';
        let currentTicketId = null;
        let currentTicketData = null;
        let allTicketsData = [];
        let ticketsPollingInterval = null;
        let messagesPollingInterval = null;
        let hasOpenTicket = false;
        let isSubmitting = false;

        const loadingView = document.getElementById('loading-view');
        const mainAppContainer = document.getElementById('main-app-container');
        const ticketsListView = document.getElementById('tickets-list-view');
        const newTicketView = document.getElementById('new-ticket-view');
        const conversationView = document.getElementById('conversation-view');
        const navButtons = { ticketsList: document.getElementById('nav-tickets-list'), newTicket: document.getElementById('nav-new-ticket') };
        const headerTitle = document.getElementById('header-title');
        const ticketsContainer = document.getElementById('tickets-container');
        const noTicketsMessage = document.getElementById('no-tickets-message');
        const newTicketForm = document.getElementById('new-ticket-form');
        const submitNewTicketBtn = document.getElementById('submit-new-ticket-btn');
        const backToTicketsBtn = document.getElementById('back-to-tickets');
        const conversationContainer = document.getElementById('conversation-container');
        const conversationHeader = document.getElementById('conversation-header');
        const replyForm = document.getElementById('reply-form');
        const replyMessageInput = document.getElementById('reply-message');
        const fileUploadInput = document.getElementById('file-upload');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const emojiBtn = document.getElementById('emoji-btn');
        
        // Info Modal Elements
        const infoModal = document.getElementById('info-modal');
        const infoModalCloseBtn = document.getElementById('info-modal-close-btn');

        // Emoji Picker Elements
        const emojiPickerContainer = document.getElementById('emoji-picker-container');
        const emojiPicker = document.querySelector('emoji-picker');
        
        // AI Enhancement Elements
        const messageTextarea = document.getElementById('message');
        const subjectInput = document.getElementById('subject');
        const aiEnhanceBtn = document.getElementById('ai-enhance-btn');
        const aiEnhanceIcon = document.getElementById('ai-enhance-icon');
        const aiEnhanceSpinner = document.getElementById('ai-enhance-spinner');
        const aiSuggestionBox = document.getElementById('ai-suggestion-box');
        const aiSuggestedSubject = document.getElementById('ai-suggested-subject');
        const aiImprovedMessage = document.getElementById('ai-improved-message');
        const aiApplyBtn = document.getElementById('ai-apply-btn');
        const aiDiscardBtn = document.getElementById('ai-discard-btn');

        const departmentMap = {
            general: 'Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªÙØ±Ù‚Ù‡',
            technical: 'ÙˆØ§Ø­Ø¯ ÙÙ†ÛŒ',
            sales: 'ÙˆØ§Ø­Ø¯ ÙØ±ÙˆØ´',
            marketing: 'ÙˆØ§Ø­Ø¯ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ',
            ideas: 'Ø§ÛŒØ¯Ù‡ Ù‡Ø§ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª'
        };

        function showNotification(message, success = true) {
            const toast = document.getElementById('notification-toast');
            toast.textContent = message;
            toast.className = `fixed top-5 right-5 text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-50 ${success ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }

        function showModal(title, message, isError = false) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const icon = isError ? `<svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` : `<svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            document.getElementById('modal-icon').innerHTML = icon;
            document.getElementById('custom-modal').classList.remove('hidden');
            document.getElementById('custom-modal').classList.add('flex');
        }

        document.getElementById('modal-close-btn').addEventListener('click', () => {
            document.getElementById('custom-modal').classList.add('hidden');
            document.getElementById('custom-modal').classList.remove('flex');
        });

        function startApp(user) {
            telegramUserId = user.id.toString();
            telegramUserName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Ú©Ø§Ø±Ø¨Ø±';
            loadingView.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
            mainAppContainer.classList.add('flex');
            showView('ticketsList');
            listenToTickets();
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const tg = window.Telegram.WebApp;
                tg.ready();
                if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                    startApp(tg.initDataUnsafe.user);
                } else {
                    console.warn("Telegram user data not found. Using mock user.");
                    startApp({id: "319237991", first_name: "Amir", last_name: "Hoseinabadi"}); 
                }
            } catch (error) { 
                console.error("Could not initialize Telegram Web App:", error);
                showModal('Ø®Ø·Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ', 'Ø§Ù…Ú©Ø§Ù† Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ ØªÙ„Ú¯Ø±Ø§Ù… ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ù„Ø·ÙØ§ Ø§Ø² Ø¯Ø§Ø®Ù„ ØªÙ„Ú¯Ø±Ø§Ù… Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.', true);
            }
        });

        function showView(viewName) {
            ticketsListView.classList.add('hidden');
            newTicketView.classList.add('hidden');
            
            if (viewName === 'ticketsList') {
                ticketsListView.classList.remove('hidden');
                headerTitle.textContent = 'ØªÛŒÚ©Øªâ€ŒÙ‡Ø§';
            } else if (viewName === 'newTicket') {
                newTicketView.classList.remove('hidden');
                headerTitle.textContent = 'ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯';
            }
            
            Object.values(navButtons).forEach(btn => btn.classList.remove('active'));
            if (navButtons[viewName]) navButtons[viewName].classList.add('active');
        }

        async function fetchTickets() {
            if (!telegramUserId) return;
            try {
                const response = await fetch(`${WORKER_URL}/tickets?telegram_id=${telegramUserId}`);
                if (!response.ok) {
                    const errorResult = await response.json().catch(() => ({ error: 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯Ø± Ø³Ø±ÙˆØ±' }));
                    throw new Error(errorResult.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§');
                }
                const result = await response.json();
                if (result.success) {
                    allTicketsData = result.data ? Object.keys(result.data).map(key => ({ id: key, ...result.data[key] })) : [];
                    renderTickets(allTicketsData);
                } else {
                    throw new Error(result.error || "Ù¾Ø§Ø³Ø® Ù†Ø§Ù…ÙˆÙÙ‚ Ø§Ø² Ø³Ø±ÙˆØ±");
                }
            } catch (error) {
                console.error("Error fetching tickets via worker:", error);
            }
        }

        function listenToTickets() {
            fetchTickets();
            if (ticketsPollingInterval) clearInterval(ticketsPollingInterval);
            ticketsPollingInterval = setInterval(fetchTickets, 5000);
        }
        
        // [MODIFIED] Improved error handling for delete operation
        async function deleteTicket(ticketId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ØªÛŒÚ©Øª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                try {
                    const response = await fetch(`${WORKER_URL}/tickets?ticket_id=${ticketId}`, { method: 'DELETE' });
                    
                    if (!response.ok) {
                        // Try to get a meaningful error message from the worker
                        let errorMsg = 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ØªÛŒÚ©Øª';
                        try {
                            const errorResult = await response.json();
                            errorMsg = errorResult.error || errorMsg;
                        } catch (e) {
                            // If the response is not JSON, use the status text
                            errorMsg = await response.text() || errorMsg;
                        }
                        throw new Error(errorMsg);
                    }

                    const result = await response.json();
                    if (result.success) {
                        showNotification('ØªÛŒÚ©Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.');
                        fetchTickets(); 
                    } else {
                        throw new Error(result.error || 'Ø­Ø°Ù ØªÛŒÚ©Øª Ø¨Ø§ Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯');
                    }
                } catch (error) {
                    // This will now catch network errors like "Failed to fetch" and server errors
                    showNotification(`Ø­Ø°Ù ØªÛŒÚ©Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯: ${error.message}`, false);
                    console.error("Error deleting ticket:", error);
                }
            }
        }

        function renderTickets(tickets) {
            hasOpenTicket = tickets.some(ticket => ['open', 'in-progress', 'answered'].includes(ticket.status));
            if (tickets.length === 0) {
                ticketsContainer.innerHTML = '';
                noTicketsMessage.classList.remove('hidden');
            } else {
                noTicketsMessage.classList.add('hidden');
                const sortedTickets = tickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                ticketsContainer.innerHTML = sortedTickets.map(renderTicket).join('');
                document.querySelectorAll('.ticket-card').forEach(card => { 
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.rating-stars')) return;
                        openConversation(card.dataset.id)
                    }); 
                });
                document.querySelectorAll('.delete-ticket-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); deleteTicket(btn.dataset.id); }); });
                
                document.querySelectorAll('.rating-star').forEach(star => {
                    star.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const ticketId = star.dataset.id;
                        const ratingValue = star.dataset.ratingValue;
                        submitRating(ticketId, parseInt(ratingValue));
                    });
                });
            }
        }
        
        async function submitRating(ticketId, rating) {
            const starContainer = document.querySelector(`.rating-stars[data-ticket-id="${ticketId}"]`);
            if (!starContainer || starContainer.dataset.submitting === 'true' || starContainer.dataset.rated === 'true') return;

            starContainer.dataset.submitting = 'true';
            starContainer.style.opacity = '0.5';

            try {
                const response = await fetch(`${WORKER_URL}/tickets/${ticketId}/rate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: rating, telegram_id: telegramUserId }),
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø²');
                }
                showNotification('Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.');
                const ticket = allTicketsData.find(t => t.id === ticketId);
                if (ticket) {
                    ticket.rating = rating;
                }
                renderTickets(allTicketsData);
            } catch (error) {
                showNotification(`Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯: ${error.message}`, false);
                delete starContainer.dataset.submitting;
                starContainer.style.opacity = '1';
            }
        }

        function renderTicket(data) {
            const status = data.status;
            const statusText = {open: 'Ø¨Ø§Ø²', 'in-progress': 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ', answered: 'Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡ Ø´Ø¯', closed: 'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡'}[status] || status;
            const creationDate = new Date(data.created_at).toLocaleString('fa-IR', { dateStyle: 'short', timeStyle: 'short' });
            const departmentName = departmentMap[data.department] || data.department;
            const deleteButton = status === 'closed' ? `<button data-id="${data.id}" class="delete-ticket-btn p-1"><svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>` : '';

            let ratingSection = '';
            if (status === 'closed') {
                if (data.rating && data.rating > 0) {
                    let stars = '';
                    for (let i = 1; i <= 5; i++) {
                        const starColor = i <= data.rating ? 'text-amber-400' : 'text-gray-600';
                        stars += `<svg class="w-5 h-5 ${starColor}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
                    }
                    ratingSection = `
                        <div class="mt-3 pt-3 border-t text-center" style="border-color: var(--brand-dark-blue);">
                            <p class="text-xs text-gray-400 mb-1">Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§:</p>
                            <div class="flex justify-center">${stars}</div>
                        </div>`;
                } else {
                    ratingSection = `
                        <div class="mt-3 pt-3 border-t text-center" style="border-color: var(--brand-dark-blue);">
                            <p class="text-xs text-gray-400 mb-2">Ø¨Ù‡ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ù‡ÛŒØ¯:</p>
                            <div class="rating-stars flex flex-row-reverse justify-center" data-ticket-id="${data.id}">
                                ${[5, 4, 3, 2, 1].map(i => `<svg data-id="${data.id}" data-rating-value="${i}" class="rating-star w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`).join('')}
                            </div>
                        </div>`;
                }
            }
            
            return `<div class="ticket-card p-4 rounded-lg shadow-lg" style="background-color: var(--brand-secondary-bg);" data-id="${data.id}">
                        <div class="flex justify-between items-start">
                            <p class="font-bold text-md">${data.subject}</p>
                            <span class="text-xs px-2 py-1 rounded-full" style="background-color: var(--brand-dark-blue);">${statusText}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs mt-4 pt-2 border-t" style="border-color: var(--brand-dark-blue);">
                            <span style="color: var(--brand-text-secondary);">${departmentName}</span>
                            <div class="flex items-center">
                                ${deleteButton}
                                <span style="color: var(--brand-text-secondary);">${creationDate}</span>
                            </div>
                        </div>
                        ${ratingSection}
                    </div>`;
        }
        
        function renderMessage(data) {
            const isUser = data.sender === 'user';
            const isAdmin = data.sender === 'admin';
            const isAI = isAdmin && data.source === 'ai';

            const messageClass = isUser ? 'message-user' : 'message-admin';
            const containerClass = isUser ? 'self-end' : 'self-start'; 
            const nameAlign = isUser ? 'text-right' : 'text-left';
            
            let senderName = '';
            if (isUser) {
                senderName = telegramUserName;
            } else if (isAI) {
                senderName = 'Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ';
            } else {
                senderName = currentTicketData ? departmentMap[currentTicketData.department] : 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ';
            }

            const time = new Date(data.created_at).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit'});
            
            let messageContent = data.text ? `<p class="whitespace-pre-wrap text-sm">${data.text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-300 underline">$1</a>')}</p>` : '';
            if (data.imageUrl) {
                messageContent += `<a href="${data.imageUrl}" target="_blank"><img src="${data.imageUrl}" class="rounded-lg max-w-xs mt-2" alt="ØªØµÙˆÛŒØ± Ù¾ÛŒÙˆØ³Øª Ø´Ø¯Ù‡"></a>`;
            }

            let humanRequestButton = '';
            if (isAI) {
                humanRequestButton = `
                    <div class="mt-3 pt-2 border-t border-white/10">
                        <p class="text-xs text-gray-400 mb-2">Ø§Ú¯Ø± Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ù…Ø´Ú©Ù„ØªØ§Ù† Ø±Ø§ Ø¨Ø±Ø·Ø±Ù Ù†Ú©Ø±Ø¯:</p>
                        <button class="request-human-btn text-xs w-full text-center py-2 px-3 rounded-lg border border-sky-500 text-sky-400 hover:bg-sky-500 hover:text-white transition-colors duration-200" data-ticket-id="${currentTicketId}">
                            Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯
                        </button>
                    </div>
                `;
            }

            return `<div class="flex flex-col ${containerClass} max-w-xs md:max-w-md">
                        <p class="sender-name ${nameAlign}" style="color: ${isUser ? '#82aaff' : '#a2a2a2'}">${senderName}</p>
                        <div class="message-bubble ${messageClass}">
                            ${messageContent}
                            ${humanRequestButton}
                        </div>
                        <span class="message-time px-2 w-full ${nameAlign}">${time}</span>
                    </div>`;
        }

        function openConversation(ticketId) {
            currentTicketId = ticketId;
            currentTicketData = allTicketsData.find(t => t.id === ticketId);
            if (!currentTicketData) {
                console.error("Could not find ticket data for ID:", ticketId);
                showNotification("Ø®Ø·Ø§: Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.", false);
                return;
            }
            
            conversationView.classList.remove('hidden');
            conversationView.classList.add('flex');
            setTimeout(() => { conversationView.classList.remove('translate-x-full'); }, 10);

            conversationHeader.textContent = currentTicketData.subject;
            listenToMessages(ticketId);
        }

        async function fetchMessages(ticketId) {
            if (!ticketId) return;
            try {
                const response = await fetch(`${WORKER_URL}/messages?ticket_id=${ticketId}`);
                if (!response.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§");
                const result = await response.json();
                if (result.success) {
                    const messagesData = result.data;
                    const currentScroll = conversationContainer.scrollTop;
                    const maxScroll = conversationContainer.scrollHeight - conversationContainer.clientHeight;
                    const isScrolledToBottom = maxScroll - currentScroll < 50;

                    conversationContainer.innerHTML = '';
                    if (messagesData) {
                        conversationContainer.innerHTML = Object.values(messagesData).sort((a,b) => new Date(a.created_at) - new Date(b.created_at)).map(renderMessage).join('');
                        attachHumanRequestListeners();
                    }
                    
                    if(isScrolledToBottom) {
                        conversationContainer.scrollTop = conversationContainer.scrollHeight;
                    }
                }
            } catch (error) {
                console.error("Error fetching messages:", error);
            }
        }

        function attachHumanRequestListeners() {
            document.querySelectorAll('.request-human-btn').forEach(button => {
                if (button.dataset.listenerAttached) return;
                button.dataset.listenerAttached = 'true';

                button.addEventListener('click', async (e) => {
                    const ticketId = e.target.dataset.ticketId;
                    if (!ticketId) return;
                    
                    e.target.disabled = true;
                    e.target.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';

                    try {
                        const response = await fetch(`${WORKER_URL}/tickets/${ticketId}/request-human`, {
                            method: 'POST'
                        });
                        if (!response.ok) {
                            throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                        }
                        const result = await response.json();
                        if (result.success) {
                            showNotification('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ø«Ø¨Øª Ø´Ø¯.');
                            e.target.textContent = 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øª Ø´Ø¯';
                            e.target.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            throw new Error(result.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª');
                        }
                    } catch (error) {
                        console.error("Error requesting human agent:", error);
                        showNotification(error.message, false);
                        e.target.disabled = false;
                        e.target.textContent = 'Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯';
                    }
                });
            });
        }

        function listenToMessages(ticketId) {
            fetchMessages(ticketId);
            if (messagesPollingInterval) clearInterval(messagesPollingInterval);
            messagesPollingInterval = setInterval(() => fetchMessages(ticketId), 3000);
        }

        function closeConversation() {
            if (messagesPollingInterval) clearInterval(messagesPollingInterval);
            conversationView.classList.add('translate-x-full');
            setTimeout(() => {
                conversationView.classList.add('hidden');
                conversationView.classList.remove('flex');
                currentTicketId = null;
                currentTicketData = null;
            }, 300);
        }

        async function sendMessage(text, imageUrl = null) {
            if (!currentTicketId || (!text && !imageUrl)) return;

            const payload = {
                ticket_id: currentTicketId,
                sender: 'user',
                text: text,
                imageUrl: imageUrl
            };

            const submitButton = replyForm.querySelector('button[type="submit"]');
            const originalButtonContent = submitButton.innerHTML;
            submitButton.disabled = true;

            try {
                const response = await fetch(`${WORKER_URL}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                 if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…');
                }
                if(text) {
                    replyMessageInput.value = '';
                    replyMessageInput.style.height = 'auto';
                }
                await fetchMessages(currentTicketId);
            } catch (error) {
                console.error("Error sending message:", error);
                showNotification(error.message, false);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
            }
        }

        const handleNewTicketSubmit = async () => {
            if (isSubmitting) return;
            const subject = document.getElementById('subject').value.trim();
            const message = document.getElementById('message').value.trim();
            const department = document.getElementById('department').value;
            if (!subject || !message) {
                showNotification("Ù„Ø·ÙØ§ Ù…ÙˆØ¶ÙˆØ¹ Ùˆ Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.", false);
                return;
            }

            isSubmitting = true;
            submitNewTicketBtn.disabled = true;
            submitNewTicketBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';

            try {
                const response = await fetch(`${WORKER_URL}/tickets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_id: telegramUserId, user_name: telegramUserName, subject, department, message }),
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª');
                }
                newTicketForm.reset();
                showNotification('ØªÛŒÚ©Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.');
                fetchTickets();
                setTimeout(() => showView('ticketsList'), 500);
            } catch (error) {
                showNotification(`Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯: ${error.message}`, false);
                console.error("Error creating ticket:", error);
            } finally {
                isSubmitting = false;
                submitNewTicketBtn.disabled = false;
                submitNewTicketBtn.textContent = 'Ø§Ø±Ø³Ø§Ù„';
            }
        };
        
        // --- AI Enhancement Logic ---

        // Disable the AI button initially
        aiEnhanceBtn.disabled = true;

        // Add event listener to the message textarea to enable/disable the AI button
        messageTextarea.addEventListener('input', () => {
            aiEnhanceBtn.disabled = messageTextarea.value.trim().length < 10; // Enable after 10 characters
            aiSuggestionBox.classList.add('hidden'); // Hide suggestions if user edits text
        });

        // Main function to call the AI service
        const handleAIEnhance = async () => {
            const userInput = messageTextarea.value.trim();
            if (userInput.length < 10) {
                showNotification("Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ØŒ Ù„Ø·ÙØ§ Ø­Ø¯Ø§Ù‚Ù„ Û±Û° Ú©Ù„Ù…Ù‡ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.", false);
                return;
            }

            aiEnhanceBtn.disabled = true;
            aiEnhanceIcon.classList.add('hidden');
            aiEnhanceSpinner.classList.remove('hidden');
            aiSuggestionBox.classList.add('hidden');

            const prompt = `You are an expert support assistant. A user has written a support ticket message in Persian. Your task is to:
1.  Generate a concise, relevant subject line in Persian for this ticket.
2.  Rewrite the user's message in formal, clear, and polite Persian. Correct any grammatical errors and improve the structure, but keep the original meaning intact.
Please return ONLY a valid JSON object with two keys: "suggested_subject" and "improved_message". Do not include any markdown, explanations, or any text outside of the JSON object.

Original message:
"${userInput}"`;

            try {
                const response = await fetch(`${WORKER_URL}${AI_ENHANCE_ENDPOINT}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt, apiKey: GPT_API_KEY }),
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø§Ø² Ø³Ø±ÙˆØ± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ' }));
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                
                const aiData = await response.json();

                if (aiData.suggested_subject && aiData.improved_message) {
                    displayAISuggestions(aiData.suggested_subject, aiData.improved_message);
                } else {
                    throw new Error("Ù¾Ø§Ø³Ø® Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ú©Ø§Ù…Ù„ Ù†Ø¨ÙˆØ¯.");
                }

            } catch (error) {
                console.error("AI enhancement failed:", error);
                showNotification(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡Ø¨ÙˆØ¯ Ù…ØªÙ†: ${error.message}`, false);
            } finally {
                aiEnhanceBtn.disabled = messageTextarea.value.trim().length < 10;
                aiEnhanceIcon.classList.remove('hidden');
                aiEnhanceSpinner.classList.add('hidden');
            }
        };

        function displayAISuggestions(subject, message) {
            aiSuggestedSubject.textContent = subject;
            aiImprovedMessage.textContent = message;
            aiSuggestionBox.classList.remove('hidden');
        }

        aiEnhanceBtn.addEventListener('click', handleAIEnhance);

        aiApplyBtn.addEventListener('click', () => {
            subjectInput.value = aiSuggestedSubject.textContent;
            messageTextarea.value = aiImprovedMessage.textContent;
            aiSuggestionBox.classList.add('hidden');
            messageTextarea.dispatchEvent(new Event('input', { bubbles: true }));
            showNotification("Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯.");
        });

        aiDiscardBtn.addEventListener('click', () => {
            aiSuggestionBox.classList.add('hidden');
        });
        
        replyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage(replyMessageInput.value.trim());
        });

        attachFileBtn.addEventListener('click', () => {
            showNotification('Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.', false);
        });

        emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPickerContainer.classList.toggle('hidden');
        });

        emojiPicker.addEventListener('emoji-click', event => {
            const emoji = event.detail.unicode;
            const textarea = replyMessageInput;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
            textarea.focus();
            emojiPickerContainer.classList.add('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!emojiPickerContainer.contains(e.target) && !emojiBtn.contains(e.target)) {
                emojiPickerContainer.classList.add('hidden');
            }
        });


        replyMessageInput.addEventListener('input', () => {
            replyMessageInput.style.height = 'auto';
            replyMessageInput.style.height = (replyMessageInput.scrollHeight) + 'px';
        });
        
        // --- Event Listeners ---
        navButtons.ticketsList.addEventListener('click', () => showView('ticketsList'));
        
        navButtons.newTicket.addEventListener('click', () => {
            if (hasOpenTicket) { 
                showModal('Ø§Ù…Ú©Ø§Ù† Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ÛŒÚ© ØªÛŒÚ©Øª Ø¨Ø§Ø² Ø¯Ø§Ø±ÛŒØ¯. Ù„Ø·ÙØ§ ØªØ§ Ø²Ù…Ø§Ù† Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ø¢Ù† ØªÙˆØ³Ø· Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯.', true);
            } else { 
                infoModal.classList.remove('hidden');
                infoModal.classList.add('flex');
            }
        });
        
        backToTicketsBtn.addEventListener('click', closeConversation);
        
        newTicketForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleNewTicketSubmit();
        });
        
        submitNewTicketBtn.addEventListener('click', handleNewTicketSubmit);

        // --- Info Modal Listener ---
        infoModalCloseBtn.addEventListener('click', () => {
            infoModal.classList.add('hidden');
            infoModal.classList.remove('flex');
            showView('newTicket');
        });
        
    </script>
</body>
</html>
