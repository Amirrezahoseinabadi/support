<script type="module">
    const WORKER_URL = 'https://support-api-worker.amiruserbot7.workers.dev';

    const SUPABASE_URL = 'https://zguqvdisadlhvswsnlyy.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const newTicketForm = document.getElementById('new-ticket-form');
    const submitNewTicketBtn = document.getElementById('submit-new-ticket-btn');
    const cancelNewTicketBtn = document.getElementById('cancel-new-ticket');

    // Submit new ticket
    const handleNewTicketSubmit = async () => {
        const subject = document.getElementById('subject').value.trim();
        const message = document.getElementById('message').value.trim();
        const department = document.getElementById('department').value;

        if (!subject || !message) {
            showNotification("لطفا تمام فیلدها را پر کنید.", "warning");
            return;
        }

        try {
            const response = await fetch(`${WORKER_URL}/tickets`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    telegram_id: telegramUserId,
                    subject: subject,
                    department: department,
                    message: message,
                }),
            });

            const result = await response.json();
            if (!response.ok || !result.success) {
                showNotification("خطا در ایجاد تیکت.", "error");
                return;
            }
            showNotification(`تیکت شما با موفقیت ثبت شد.`, 'success');
            setTimeout(() => {
                // Redirect to tickets list or handle after ticket creation
            }, 1000);
        } catch (error) {
            console.error("Error creating new ticket via worker: ", error);
            showNotification("خطا در ایجاد تیکت.", 'error');
        }
    };
    
    submitNewTicketBtn.addEventListener('click', handleNewTicketSubmit);
    cancelNewTicketBtn.addEventListener('click', () => showView('ticketsList'));
</script>
