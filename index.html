<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#f0f4f8',       
                            surface: '#ffffff',  
                            primary: '#0ea5e9',  // Sky 500
                            primaryHover: '#0284c7', 
                            secondary: '#84cc16', // Lime
                            text: '#1e293b',     // Slate 800
                            muted: '#64748b',
                            ai: '#8b5cf6',       // Violet
                        }
                    },
                    fontFamily: {
                        sans: ['Vazirmatn', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-3px)' },
                        },
                        'pulse-glow': {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 10px rgba(14, 165, 233, 0.3)' },
                            '50%': { opacity: .9, boxShadow: '0 0 20px rgba(14, 165, 233, 0.1)' },
                        },
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 }
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #f0f4f8;
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 24px 24px; 
            color: #1e293b;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Glass Blue Effect */
        .glass-blue {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 
                0 4px 6px -1px rgba(14, 165, 233, 0.05), 
                0 10px 15px -3px rgba(14, 165, 233, 0.1),
                inset 0 0 20px rgba(224, 242, 254, 0.4);
        }
        
        /* Animated Glass for Smart Card */
        .glass-animated {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .glass-nav-blue {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(25px);
            border-top: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 -4px 20px rgba(14, 165, 233, 0.08);
        }

        .form-input, .form-select, .form-textarea {
            background-color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(203, 213, 225, 0.6);
            color: #334155;
            border-radius: 1rem;
            padding: 0.8rem 1rem;
            width: 100%;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(5px);
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #0ea5e9;
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2);
            transform: translateY(-1px);
        }
        .form-input::placeholder, .form-textarea::placeholder { color: #94a3b8; }

        .ai-btn-small {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            color: #0ea5e9;
            border: 1px solid #bae6fd;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(14, 165, 233, 0.1);
        }
        .ai-btn-small:hover {
            background: #fff;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.2);
        }

        /* Chat Background */
        #conversation-container {
            background-color: #e0f2fe; 
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%230ea5e9' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2V6h4V4H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .message-bubble {
            padding: 10px 14px;
            border-radius: 16px;
            max-width: 85%;
            width: fit-content;
            word-wrap: break-word;
            font-size: 0.92rem;
            line-height: 1.5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        
        .message-user {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: #ffffff;
            border-bottom-right-radius: 2px;
            box-shadow: 0 4px 10px rgba(14, 165, 233, 0.25);
        }
        
        .message-admin {
            background-color: rgba(255, 255, 255, 0.9);
            color: #1e293b;
            border: 1px solid #f1f5f9;
            border-bottom-left-radius: 2px;
            backdrop-filter: blur(4px);
        }

        .nav-button { opacity: 0.6; transition: all 0.2s; }
        .nav-button.active { opacity: 1; color: #0ea5e9; transform: scale(1.05); }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-item { animation: slideInUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
        
        #conversation-view {
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform: translateX(100%);
        }
        #conversation-view.is-open { transform: translateX(0%); }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        .modal-backdrop {
            backdrop-filter: blur(8px);
            background-color: rgba(15, 23, 42, 0.3);
        }
        
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
    </style>
</head>
<body class="flex flex-col h-screen font-sans overflow-hidden text-sm bg-brand-bg text-brand-text">

    <input type="file" id="file-upload" class="hidden" accept="image/*">

    <!-- Loading View -->
    <div id="loading-view" class="flex flex-col items-center justify-center h-full text-center p-4 z-50 bg-brand-bg absolute inset-0">
        <div class="relative w-14 h-14 mb-4">
            <div class="absolute inset-0 rounded-full border-[3px] border-slate-200"></div>
            <div class="absolute inset-0 rounded-full border-[3px] border-brand-primary border-t-transparent animate-spin"></div>
        </div>
        <p class="text-brand-muted text-xs font-medium animate-pulse">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø·...</p>
    </div>

    <!-- Main App -->
    <div id="main-app-container" class="hidden h-full flex-col relative w-full">
        
        <!-- Header -->
        <header class="glass-blue sticky top-0 z-20 px-4 h-16 flex items-center justify-between pt-safe shadow-sm transition-shadow">
            <div class="w-24"></div> <!-- Spacer -->
            <h1 id="header-title" class="text-slate-800 text-lg font-bold tracking-tight">ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</h1>
            
            <!-- Online Admin Status -->
            <div class="w-24 flex justify-end items-center gap-2">
                 <span id="admin-count" class="text-[10px] font-bold text-brand-secondary opacity-0 animate-fade-in whitespace-nowrap transition-opacity duration-1000">
                     <!-- Populated by JS -->
                 </span>
                 <span class="flex h-2.5 w-2.5 relative flex-shrink-0">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-secondary opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-brand-secondary"></span>
                  </span>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="app-container" class="flex-grow overflow-y-auto w-full pb-24">
            
            <!-- Tickets List -->
            <div id="tickets-list-view" class="p-5 w-full max-w-lg mx-auto">
                <!-- Smart Card with Animated Floating Colors -->
                <div id="smart-card" class="glass-animated p-5 rounded-3xl mb-6 fade-in-item relative overflow-hidden group hover:shadow-lg transition-shadow duration-300">
                    
                    <!-- Floating Color Blobs (Background) -->
                    <div class="absolute top-0 -left-4 w-48 h-48 bg-purple-300 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob"></div>
                    <div class="absolute top-0 -right-4 w-48 h-48 bg-yellow-200 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob animation-delay-2000"></div>
                    <div class="absolute -bottom-8 left-20 w-48 h-48 bg-pink-200 rounded-full mix-blend-multiply filter blur-2xl opacity-60 animate-blob animation-delay-4000"></div>
                    
                    <!-- Content (Foreground) -->
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-3">
                            <h3 id="smart-card-greeting" class="text-lg font-bold text-slate-800">Ø³Ù„Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¹Ø²ÛŒØ²! ğŸ‘‹</h3>
                        </div>
                        
                        <div class="p-4 rounded-2xl bg-white/60 text-xs mb-5 border border-white/40 leading-relaxed text-slate-700 shadow-sm backdrop-blur-sm">
                            <p><span class="text-lg align-middle ml-1">ğŸ’¡</span> <span class="font-bold text-brand-secondary">Ù†Ú©ØªÙ‡ Ø§Ù…Ø±ÙˆØ²:</span> Ø¢ÛŒØ§ Ù…ÛŒØ¯Ø§Ù†Ø³ØªÛŒØ¯ Ø¨Ø§ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ø¨Ù‡ <span class="font-bold text-brand-primary">Ù¾Ø§ÛŒÙ€Ú¯Ø§Ù‡ Ø¯Ø§Ù†Ù€Ù€Ø´</span>ØŒ Ù¾Ø§Ø³Ø® 90% Ø³ÙˆØ§Ù„Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ</p>
                        </div>
                        <button id="faq-button" class="w-full bg-brand-primary/90 hover:bg-brand-primary text-white text-sm font-bold py-3.5 rounded-xl shadow-lg shadow-sky-500/20 transition-all active:scale-[0.98] backdrop-blur-md">
                            Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„
                        </button>
                    </div>
                </div>

                <div id="tickets-container" class="space-y-4"></div>

                <div id="no-tickets-message" class="hidden flex flex-col items-center justify-center mt-20 text-brand-muted fade-in-item">
                    <div class="bg-white/50 p-6 rounded-full mb-4 border border-dashed border-sky-200 shadow-sm">
                        <svg class="h-10 w-10 opacity-40 text-sky-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    </div>
                    <p class="text-sm font-medium text-slate-500">Ù‡Ù†ÙˆØ² ØªÛŒÚ©ØªÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯</p>
                </div>
            </div>

            <!-- New Ticket Form -->
            <div id="new-ticket-view" class="p-5 hidden w-full max-w-lg mx-auto">
                <form id="new-ticket-form" class="space-y-5 fade-in-item">
                    <div class="glass-blue p-5 rounded-3xl space-y-4">
                        <div>
                            <label for="department" class="block mb-2 text-xs font-bold text-slate-700 mr-1">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†</label>
                            <div class="relative group">
                                <select id="department" name="department" class="form-select appearance-none cursor-pointer">
                                    <option value="general">Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªÙØ±Ù‚Ù‡</option>
                                    <option value="technical">ÙˆØ§Ø­Ø¯ ÙÙ†ÛŒ</option>
                                    <option value="sales">ÙˆØ§Ø­Ø¯ ÙØ±ÙˆØ´</option>
                                    <option value="marketing">ÙˆØ§Ø­Ø¯ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ</option>
                                    <option value="ideas">Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center px-3 text-slate-400 group-hover:text-brand-primary transition-colors">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="subject" class="block mb-2 text-xs font-bold text-slate-700 mr-1">Ù…ÙˆØ¶ÙˆØ¹</label>
                            <input type="text" id="subject" name="subject" class="form-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ú©ÙˆØªØ§Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª..." required>
                        </div>
                    </div>

                    <div class="glass-blue p-5 rounded-3xl relative">
                        <label for="message" class="block mb-2 text-xs font-bold text-slate-700 mr-1">Ù…ØªÙ† Ù¾ÛŒØ§Ù…</label>
                        <textarea id="message" name="message" rows="7" class="form-textarea resize-none pb-12" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." required></textarea>
                        
                        <button type="button" id="ai-assist-btn" class="absolute bottom-4 left-4 ai-btn-small px-3 py-1.5 rounded-xl text-[11px] font-bold flex items-center gap-1.5 z-10" title="Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ø§Ø±Ø´ Ø¨Ù‡ØªØ±">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <span>Ø§ØµÙ„Ø§Ø­ Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
                        </button>
                    </div>

                    <div class="pt-2">
                        <button type="submit" id="submit-new-ticket-btn" class="w-full bg-brand-primary hover:bg-brand-primaryHover text-white py-3.5 rounded-2xl font-bold text-base shadow-lg shadow-sky-500/30 transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed">
                            Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª
                        </button>
                    </div>
                </form>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav id="main-nav" class="glass-nav-blue fixed bottom-0 w-full z-30 flex items-start justify-around pb-safe pt-3 h-[calc(70px+env(safe-area-inset-bottom))]">
            <button id="nav-tickets-list" class="nav-button active flex flex-col items-center justify-center w-1/2 h-full -mt-1 group">
                <svg class="h-7 w-7 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                <span class="text-[11px] font-bold">ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</span>
            </button>
            <button id="nav-new-ticket" class="nav-button flex flex-col items-center justify-center w-1/2 h-full -mt-1 group">
                <div class="bg-transparent group-hover:bg-sky-50 p-1.5 rounded-xl transition-colors">
                    <svg class="h-7 w-7 text-current" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                </div>
                <span class="text-[11px] font-bold mt-0.5">Ø«Ø¨Øª ØªÛŒÚ©Øª</span>
            </button>
        </nav>
    </div>

    <!-- AI Suggestion Modal -->
    <div id="ai-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[70] p-5 transition-all duration-300">
        <div class="glass-blue p-5 rounded-3xl w-full max-w-md flex flex-col shadow-2xl animate-[slideInUp_0.3s_ease-out]">
            <div class="text-center mb-5">
                <div class="w-14 h-14 bg-sky-100/80 text-sky-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-inner">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
                <p class="text-xs text-slate-500 mt-1">Ù…ØªÙ† Ø´Ù…Ø§ ØªÙˆØ³Ø· Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯</p>
            </div>
            
            <div class="space-y-3 overflow-y-auto mb-5 pr-1 max-h-[50vh]">
                <div class="bg-white/60 p-4 rounded-2xl border border-sky-100/50 shadow-sm">
                    <span class="text-[10px] text-sky-600 font-bold block mb-1 uppercase tracking-wider">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†</span>
                    <p id="ai-suggested-dept-text" class="text-sm font-medium text-slate-800">...</p>
                    <input type="hidden" id="ai-suggested-dept-value">
                </div>
                <div class="bg-white/60 p-4 rounded-2xl border border-sky-100/50 shadow-sm">
                    <span class="text-[10px] text-sky-600 font-bold block mb-1 uppercase tracking-wider">Ù…ÙˆØ¶ÙˆØ¹</span>
                    <p id="ai-suggested-subject" class="text-sm font-medium text-slate-800">...</p>
                </div>
                <div class="bg-white/60 p-4 rounded-2xl border border-sky-100/50 shadow-sm">
                    <span class="text-[10px] text-sky-600 font-bold block mb-1 uppercase tracking-wider">Ù…ØªÙ† Ù¾ÛŒØ§Ù…</span>
                    <p id="ai-suggested-message" class="text-sm font-medium text-slate-800 whitespace-pre-wrap leading-relaxed">...</p>
                </div>
            </div>

            <div class="flex gap-3 pt-3 border-t border-sky-100/50">
                <button id="ai-reject-btn" class="flex-1 bg-white/70 hover:bg-white text-slate-600 py-3 rounded-xl text-sm font-bold transition-colors">Ø§Ù†ØµØ±Ø§Ù</button>
                <button id="ai-apply-btn" class="flex-[2] bg-brand-primary hover:bg-brand-primaryHover text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-sky-500/25 transition-transform active:scale-[0.98]">
                    ØªØ§ÛŒÛŒØ¯ Ùˆ Ø¬Ø§ÛŒÚ¯Ø°Ø§Ø±ÛŒ
                </button>
            </div>
        </div>
    </div>

    <!-- AI Precheck Modal -->
    <div id="ai-precheck-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[70] p-6 transition-all duration-300">
        <div class="glass-blue p-6 rounded-3xl w-full max-w-sm flex flex-col shadow-2xl animate-[slideInUp_0.3s_ease-out] text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-sky-400 to-blue-500"></div>
            
            <div class="mx-auto mb-4 p-4 bg-sky-50/80 rounded-full w-fit text-sky-600 shadow-sm">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
            </div>
            <h3 class="text-lg font-bold text-slate-900 mb-2">Ø§ØµÙ„Ø§Ø­ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…ØªÙ†ØŸ</h3>
            <p class="text-sm text-slate-500 leading-relaxed mb-6 px-2">
                Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù…ØªÙ† ØªÛŒÚ©Øª Ø´Ù…Ø§ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ùˆ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ØŒ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ú©Ù†Ø¯ØŸ
            </p>
            <div class="flex flex-col gap-3">
                <button id="ai-precheck-yes" class="w-full bg-brand-primary hover:bg-brand-primaryHover text-white py-3.5 rounded-xl text-sm font-bold shadow-lg shadow-sky-500/25 transition-transform active:scale-[0.98]">
                    Ø¨Ù„Ù‡ØŒ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­ Ú©Ù† âœ¨
                </button>
                <button id="ai-precheck-no" class="w-full bg-white/70 border border-sky-100 hover:bg-white text-slate-500 py-3 rounded-xl text-sm font-medium transition-colors">
                    Ø®ÛŒØ±ØŒ Ù‡Ù…ÛŒÙ† Ù…ØªÙ† Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯
                </button>
            </div>
        </div>
    </div>

    <!-- Conversation View -->
    <div id="conversation-view" class="fixed inset-0 z-40 flex flex-col bg-brand-bg h-[100dvh] hidden">
        <header class="glass-blue sticky top-0 z-10 px-4 h-16 flex items-center shadow-sm pt-safe">
            <button id="back-to-tickets" class="p-2 -mr-2 rounded-full active:bg-sky-100 text-slate-600 transform rotate-180 transition-colors">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
            </button>
            <div class="flex flex-col mr-3 overflow-hidden">
                <h2 id="conversation-header" class="text-slate-800 font-bold text-base truncate">...</h2>
                <span class="text-[11px] text-brand-secondary flex items-center gap-1.5 font-medium mt-0.5">
                    <span class="w-2 h-2 rounded-full bg-brand-secondary animate-pulse"></span>
                    <span>Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø³Ø±ÛŒØ¹</span>
                </span>
            </div>
         </header>
        
        <div id="conversation-container" class="p-4 space-y-4 flex flex-col flex-grow overflow-y-auto pb-4"></div>
        
        <div id="emoji-picker-container" class="absolute bottom-[85px] left-4 z-50 hidden shadow-2xl rounded-3xl overflow-hidden border border-sky-100">
            <emoji-picker style="width: 320px; height: 350px; --font-size: 15px; --background: rgba(255,255,255,0.95); --text-color: #1e293b; --border-color: #e2e8f0; --category-emoji-size: 1.2rem;"></emoji-picker>
        </div>

         <div id="reply-box" class="p-3 sticky bottom-0 glass-nav-blue pb-safe">
            <form id="reply-form" class="flex items-end gap-2 bg-white/70 border border-sky-100 rounded-[1.2rem] p-2 focus-within:border-brand-primary/50 focus-within:ring-2 focus-within:ring-sky-100 transition-all shadow-sm backdrop-blur-sm">
                <button type="button" id="attach-file-btn" class="p-2.5 text-slate-400 hover:text-brand-primary hover:bg-sky-50 rounded-xl transition-colors">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
                </button>
                <textarea id="reply-message" rows="1" class="flex-grow bg-transparent border-none text-slate-800 placeholder-slate-400 py-3 max-h-[120px] resize-none focus:ring-0 text-sm leading-relaxed" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." required style="min-height: 44px;"></textarea>
                <button type="button" id="emoji-btn" class="p-2.5 text-slate-400 hover:text-brand-primary hover:bg-sky-50 rounded-xl transition-colors">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
                <button type="submit" class="bg-brand-primary hover:bg-brand-primaryHover text-white p-3 rounded-xl shadow-md shadow-sky-500/20 transition-all active:scale-95">
                    <svg class="h-5 w-5 rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </form>
        </div>
        <div id="closed-ticket-banner" class="p-4 text-center bg-slate-50/90 pb-safe border-t border-slate-200 text-slate-500 text-xs hidden backdrop-blur-md font-medium">
            <p class="flex items-center justify-center gap-2">Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ ØªÙˆØ³Ø· Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
        </div>
    </div>

    <!-- Info Modal with Original Content -->
    <div id="info-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-5 transition-all duration-300">
        <div class="glass-blue p-6 rounded-3xl w-full max-w-md flex flex-col shadow-2xl animate-[slideInUp_0.3s_ease-out] max-h-[85vh]">
            <div class="text-center mb-5">
                 <div class="w-14 h-14 bg-sky-100/80 text-sky-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-inner">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-lg font-bold text-slate-900">Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª</h3>
            </div>
            <div class="overflow-y-auto space-y-5 text-sm text-slate-600 leading-relaxed pr-1 mb-2">
                <div>
                    <h4 class="font-bold text-slate-800 mb-2 flex items-center gap-2 text-sm"><span class="text-xl">ğŸ’¡</span> Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª:</h4>
                    <p class="text-xs">Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ <a href="#" id="faq-link-modal" class="text-brand-primary hover:underline font-bold">ØµÙØ­Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„</a> Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯. Ø´Ø§ÛŒØ¯ Ù¾Ø§Ø³Ø® Ø³ÙˆØ§Ù„ Ø´Ù…Ø§ Ø¢Ù†Ø¬Ø§ Ø¨Ø§Ø´Ø¯!</p>
                </div>
                <div class="bg-white/50 p-4 rounded-2xl border border-sky-100/50 shadow-sm">
                     <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2 text-sm"><span class="text-xl">ğŸ“‹</span> Ù†Ù…ÙˆÙ†Ù‡ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª:</h4>
                    <div class="p-3 rounded-xl bg-white/70 font-mono text-[11px] border border-sky-50 text-slate-500 shadow-inner leading-loose">
                        <p class="mb-0 whitespace-pre-line"><span class="text-brand-primary font-bold">Ø¯Ù¾Ø§Ø±ØªÙ…Ø§Ù†:</span> (Ù†Ø³Ø¨Øª Ø¨Ù‡ Ù…ÙˆØ¶ÙˆØ¹ ØªÛŒÚ©Øª ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆØ¯)
                        <span class="text-brand-primary font-bold">Ù…ÙˆØ¶ÙˆØ¹:</span> Ø¹Ø¯Ù… Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø³ÙˆØ±Ø¯ Ù¾Ù†Ù„
                        <span class="text-brand-primary font-bold">Ù…ØªÙ† Ù¾ÛŒØ§Ù…:</span> Ø³Ù„Ø§Ù… Ùˆ ÙˆÙ‚Øª Ø¨Ø®ÛŒØ±ØŒ Ø¨Ù†Ø¯Ù‡ Ø¯Ø± Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆÛŒØ³ Ø§Ù…Ú©Ø§Ù† ØªØºÛŒÛŒØ±/Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø³ÙˆØ±Ø¯ Ù¾Ù†Ù„Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±Ù….
                        Ù„Ø·ÙØ§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø§Ø±Ù… Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø±ÙØ¹ Ø¨ÙØ±Ù…Ø§ÛŒÛŒØ¯.</p>
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-sky-100/50">
                <button id="info-modal-close-btn" class="w-full bg-brand-primary hover:bg-brand-primaryHover text-white py-3 rounded-xl text-sm font-bold transition-all shadow-lg shadow-sky-500/20 active:scale-[0.98]">Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…</button>
            </div>
        </div>
    </div>
    
    <div id="custom-modal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-6">
        <div class="glass-blue p-6 rounded-3xl w-full max-w-sm text-center shadow-2xl">
            <div id="modal-icon" class="mx-auto mb-4 p-3 bg-sky-50 rounded-full w-fit"></div>
            <h3 id="modal-title" class="text-lg font-bold mb-2 text-slate-900"></h3>
            <p id="modal-message" class="text-slate-500 mb-6 text-sm leading-relaxed"></p>
            <button id="modal-close-btn" class="bg-brand-primary hover:bg-brand-primaryHover text-white w-full py-3 rounded-xl text-sm font-bold shadow-md transition-all active:scale-[0.98]">Ø¨Ø§Ø´Ù‡</button>
        </div>
    </div>

    <div id="notification-toast" class="fixed top-5 left-5 right-5 glass-blue text-slate-800 px-5 py-4 rounded-2xl shadow-xl shadow-sky-500/10 opacity-0 transition-all duration-300 z-[60] flex items-center gap-3 text-sm font-bold transform -translate-y-full border-sky-100"></div>

    <script>
        const WORKER_URL = 'https://support-api-worker.amiruserbot7.workers.dev';
        const GAP_API_KEY = 'sk-Nw4XNHLaLaOut6ZxhP7WJSsANA2QURK6hR7gx57UJUxubmCT';
        const GAP_BASE_URL_PRIMARY = 'https://api.gapgpt.app/v1';
        const GAP_BASE_URL_BACKUP = 'https://api.gapapi.com/v1';
        const AI_MODEL = 'gpt-4o'; 

        const firebaseConfig = {
            apiKey: "AIzaSyAjBkdCe-kJK2VFfM3lSFyFiFNXElOCPSg",
            authDomain: "support-app-final.firebaseapp.com",
            databaseURL: "https://support-app-final-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "support-app-final",
            messagingSenderId: "220983533006",
            appId: "1:220983533006:web:87f404486afb9f6a06df9f"
        };

        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        let telegramUserId = null;
        let telegramUserName = 'Ú©Ø§Ø±Ø¨Ø±';
        let currentTicketId = null;
        let currentTicketData = null;
        let allTicketsData = [];
        let ticketsPollingInterval = null;
        let messagesPollingInterval = null;
        let hasOpenTicket = false;
        let isSubmitting = false;
        let isAiChecked = false;

        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.expand();
            tg.setHeaderColor('#f0f4f8'); 
            tg.setBackgroundColor('#f0f4f8');
            tg.enableClosingConfirmation();
        }

        const loadingView = document.getElementById('loading-view');
        const mainAppContainer = document.getElementById('main-app-container');
        const ticketsListView = document.getElementById('tickets-list-view');
        const newTicketView = document.getElementById('new-ticket-view');
        const conversationView = document.getElementById('conversation-view');
        const navButtons = { ticketsList: document.getElementById('nav-tickets-list'), newTicket: document.getElementById('nav-new-ticket') };
        const headerTitle = document.getElementById('header-title');
        const ticketsContainer = document.getElementById('tickets-container');
        const noTicketsMessage = document.getElementById('no-tickets-message');
        const newTicketForm = document.getElementById('new-ticket-form');
        const submitNewTicketBtn = document.getElementById('submit-new-ticket-btn');
        const backToTicketsBtn = document.getElementById('back-to-tickets');
        const conversationContainer = document.getElementById('conversation-container');
        const conversationHeader = document.getElementById('conversation-header');
        const replyBox = document.getElementById('reply-box');
        const closedTicketBanner = document.getElementById('closed-ticket-banner');
        const replyForm = document.getElementById('reply-form');
        const replyMessageInput = document.getElementById('reply-message');
        const fileUploadInput = document.getElementById('file-upload');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const emojiBtn = document.getElementById('emoji-btn');
        const infoModal = document.getElementById('info-modal');
        const infoModalCloseBtn = document.getElementById('info-modal-close-btn');
        const emojiPickerContainer = document.getElementById('emoji-picker-container');
        const emojiPicker = document.querySelector('emoji-picker');
        
        const aiAssistBtn = document.getElementById('ai-assist-btn');
        const aiModal = document.getElementById('ai-modal');
        const aiRejectBtn = document.getElementById('ai-reject-btn');
        const aiApplyBtn = document.getElementById('ai-apply-btn');
        const aiPrecheckModal = document.getElementById('ai-precheck-modal');
        const aiPrecheckYes = document.getElementById('ai-precheck-yes');
        const aiPrecheckNo = document.getElementById('ai-precheck-no');

        const departmentMap = {
            general: 'Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªÙØ±Ù‚Ù‡',
            technical: 'ÙˆØ§Ø­Ø¯ ÙÙ†ÛŒ',
            sales: 'ÙˆØ§Ø­Ø¯ ÙØ±ÙˆØ´',
            marketing: 'ÙˆØ§Ø­Ø¯ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ',
            ideas: 'Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª'
        };

        const statusInfo = {
            open: { text: 'Ø¨Ø§Ø²', colorClass: 'bg-brand-secondary', bgClass: 'bg-lime-50 text-brand-secondary border border-lime-200' },
            'in-progress': { text: 'Ø¨Ø±Ø±Ø³ÛŒ', colorClass: 'bg-amber-400', bgClass: 'bg-amber-50 text-amber-600 border border-amber-200' },
            answered: { text: 'Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡', colorClass: 'bg-brand-primary', bgClass: 'bg-sky-50 text-brand-primary border border-sky-200' },
            closed: { text: 'Ø¨Ø³ØªÙ‡', colorClass: 'bg-slate-400', bgClass: 'bg-slate-100 text-slate-500 border border-slate-200' }
        };
        
        // Admin Count Logic
        const updateAdminCount = () => {
            const STORAGE_KEY_COUNT = 'support_admin_count';
            const STORAGE_KEY_TIME = 'support_admin_time';
            const INTERVAL = 6 * 60 * 60 * 1000; // 6 hours

            const now = Date.now();
            let count = localStorage.getItem(STORAGE_KEY_COUNT);
            let lastTime = localStorage.getItem(STORAGE_KEY_TIME);

            if (!count || !lastTime || (now - lastTime > INTERVAL)) {
                count = Math.floor(Math.random() * 4) + 1; // 1 to 4
                localStorage.setItem(STORAGE_KEY_COUNT, count);
                localStorage.setItem(STORAGE_KEY_TIME, now);
            }

            const countEl = document.getElementById('admin-count');
            if(countEl) {
                countEl.textContent = `${count} Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†`;
                countEl.classList.remove('opacity-0');
            }
        };

        let activeToastTimeout = null;
        function showNotification(message, success = true, duration = 3000) {
            const toast = document.getElementById('notification-toast');
            const icon = success 
                ? `<svg class="w-6 h-6 text-brand-secondary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`
                : `<svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;

            toast.innerHTML = `${icon} <span>${message}</span>`;
            toast.className = `fixed top-5 left-5 right-5 glass-blue px-5 py-4 rounded-2xl shadow-xl transition-all duration-300 z-[60] flex items-center gap-3 text-sm font-bold ${success ? 'border-lime-200 text-slate-800' : 'border-red-200 text-slate-800'} transform translate-y-0`;
            
            if(activeToastTimeout) clearTimeout(activeToastTimeout);
            toast.classList.remove('opacity-0', '-translate-y-full');
            
            if (duration > 0) {
                activeToastTimeout = setTimeout(() => {
                    toast.classList.add('opacity-0', '-translate-y-full');
                }, duration);
            }
        }

        function showModal(title, message, isError = false) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const icon = isError 
                ? `<svg class="w-12 h-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`
                : `<svg class="w-12 h-12 text-brand-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
            document.getElementById('modal-icon').innerHTML = icon;
            document.getElementById('custom-modal').classList.remove('hidden');
            document.getElementById('custom-modal').classList.add('flex');
        }

        document.getElementById('modal-close-btn').addEventListener('click', () => {
            document.getElementById('custom-modal').classList.add('hidden');
            document.getElementById('custom-modal').classList.remove('flex');
        });

        function startApp(user) {
            telegramUserId = user.id.toString();
            telegramUserName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Ú©Ø§Ø±Ø¨Ø±';
            document.getElementById('smart-card-greeting').textContent = `Ø³Ù„Ø§Ù… ${telegramUserName}! ğŸ‘‹`;
            loadingView.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
            mainAppContainer.classList.add('flex');
            showView('ticketsList');
            listenToTickets();
            updateAdminCount();
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const tg = window.Telegram ? window.Telegram.WebApp : null;
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
                    tg.ready();
                    startApp(tg.initDataUnsafe.user);
                } else {
                    startApp({id: "319237991", first_name: "Amir", last_name: "Hoseinabadi"});
                }
            } catch (error) {
                startApp({id: "319237991", first_name: "Amir", last_name: "Hoseinabadi"});
            }
        });

        function showView(viewName) {
            ticketsListView.classList.add('hidden');
            newTicketView.classList.add('hidden');
            if (viewName === 'ticketsList') {
                ticketsListView.classList.remove('hidden');
                headerTitle.textContent = 'ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†';
            } else if (viewName === 'newTicket') {
                newTicketView.classList.remove('hidden');
                headerTitle.textContent = 'Ø«Ø¨Øª ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯';
            }
            Object.values(navButtons).forEach(btn => btn.classList.remove('active'));
            if (navButtons[viewName]) navButtons[viewName].classList.add('active');
        }

        async function fetchTickets() {
            if (!telegramUserId) return;
            try {
                const response = await fetch(`${WORKER_URL}/tickets?telegram_id=${telegramUserId}`);
                if (!response.ok) return;
                const result = await response.json();
                if (result.success) {
                    allTicketsData = result.data ? Object.keys(result.data).map(key => ({ id: key, ...result.data[key] })) : [];
                    if (currentTicketId) {
                        const updatedTicketData = allTicketsData.find(t => t.id === currentTicketId);
                        if (updatedTicketData && currentTicketData && updatedTicketData.status !== currentTicketData.status) {
                            currentTicketData = updatedTicketData;
                            updateConversationViewUI();
                        }
                    }
                    renderTickets(allTicketsData);
                }
            } catch (error) { console.error("Error fetching tickets:", error); }
        }

        function listenToTickets() {
            fetchTickets();
            if (ticketsPollingInterval) clearInterval(ticketsPollingInterval);
            ticketsPollingInterval = setInterval(fetchTickets, 10000); 
        }

        async function deleteTicket(ticketId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                try {
                    const response = await fetch(`${WORKER_URL}/tickets?ticket_id=${ticketId}`, { method: 'DELETE' });
                     if (!response.ok) throw new Error('Ø®Ø·Ø§');
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Ø­Ø°Ù Ø´Ø¯.');
                        fetchTickets();
                    }
                } catch (error) { showNotification(`Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù`, false); }
            }
        }

        function renderTickets(tickets) {
            hasOpenTicket = tickets.some(ticket => ['open', 'in-progress', 'answered'].includes(ticket.status));
            if (tickets.length === 0) {
                ticketsContainer.innerHTML = '';
                noTicketsMessage.classList.remove('hidden');
            } else {
                noTicketsMessage.classList.add('hidden');
                const sortedTickets = tickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                ticketsContainer.innerHTML = sortedTickets.map((ticket, index) => renderTicket(ticket, index)).join('');
                document.querySelectorAll('.ticket-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.rating-stars') || e.target.closest('.delete-ticket-btn')) return;
                        openConversation(card.dataset.id)
                    });
                });
                document.querySelectorAll('.delete-ticket-btn').forEach(btn => { 
                    btn.addEventListener('click', (e) => { e.stopPropagation(); deleteTicket(btn.dataset.id); }); 
                });
                document.querySelectorAll('.rating-star').forEach(star => {
                    star.addEventListener('click', (e) => {
                        e.stopPropagation();
                        submitRating(star.dataset.id, parseInt(star.dataset.ratingValue));
                    });
                });
            }
        }

        async function submitRating(ticketId, rating) {
            const starContainer = document.querySelector(`.rating-stars[data-ticket-id="${ticketId}"]`);
            if (!starContainer || starContainer.dataset.submitting === 'true' || starContainer.dataset.rated === 'true') return;
            starContainer.dataset.submitting = 'true';
            starContainer.style.opacity = '0.5';
            try {
                const response = await fetch(`${WORKER_URL}/tickets/${ticketId}/rate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: rating, telegram_id: telegramUserId }),
                });
                if (!response.ok) throw new Error('Error');
                showNotification('Ø«Ø¨Øª Ø´Ø¯.');
                const ticket = allTicketsData.find(t => t.id === ticketId);
                if (ticket) ticket.rating = rating;
                renderTickets(allTicketsData);
            } catch (error) {
                delete starContainer.dataset.submitting;
                starContainer.style.opacity = '1';
            }
        }

        function renderTicket(data, index) {
            const status = data.status;
            const statusDetails = statusInfo[status] || { text: status, colorClass: 'bg-slate-400', bgClass: 'bg-slate-50 text-slate-500 border border-slate-100' };
            const creationDate = new Date(data.created_at).toLocaleString('fa-IR', { dateStyle: 'short', timeStyle: 'short' });
            const departmentName = departmentMap[data.department] || data.department;
            const deleteButton = status === 'closed' ? `<button data-id="${data.id}" class="delete-ticket-btn p-2 text-slate-400 hover:text-red-500 z-10 -ml-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>` : '';
            let ratingSection = '';
            if (status === 'closed') {
                if (data.rating && data.rating > 0) {
                    let stars = '';
                    for (let i = 1; i <= 5; i++) {
                        const starColor = i <= data.rating ? 'text-amber-400' : 'text-slate-300';
                        stars += `<svg class="w-4 h-4 ${starColor}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
                    }
                    ratingSection = `<div class="mt-2 pt-2 border-t border-dashed border-slate-200 flex items-center justify-between"><span class="text-[10px] text-slate-500">Ø§Ù…ØªÛŒØ§Ø²:</span><div class="flex gap-0.5">${stars}</div></div>`;
                } else {
                    ratingSection = `<div class="mt-2 pt-2 border-t border-dashed border-slate-200 flex items-center justify-between"><span class="text-[10px] text-slate-500">Ø«Ø¨Øª Ù†Ø¸Ø±:</span><div class="rating-stars flex flex-row-reverse gap-1" data-ticket-id="${data.id}">${[5, 4, 3, 2, 1].map(i => `<svg data-id="${data.id}" data-rating-value="${i}" class="rating-star w-5 h-5 text-slate-300 hover:text-amber-400 transition-colors" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`).join('')}</div></div>`;
                }
            }
            return `<div class="ticket-card glass-blue p-4 rounded-2xl fade-in-item active:scale-[0.99] transition-transform mb-3 relative overflow-hidden group hover:shadow-md" style="animation-delay: ${index * 50}ms;" data-id="${data.id}"><div class="absolute top-0 right-0 w-1 h-full ${statusDetails.colorClass}"></div><div class="flex justify-between items-start mb-2 pl-1"><h4 class="font-bold text-sm text-slate-800 truncate max-w-[60%]">${data.subject}</h4><span class="flex items-center text-[10px] px-2.5 py-1 rounded-full ${statusDetails.bgClass}">${statusDetails.text}</span></div><div class="flex justify-between items-end text-[11px] text-slate-500 mt-2"><div class="flex flex-col gap-1"><span class="flex items-center gap-1">${departmentName}</span><span class="flex items-center gap-1">${creationDate}</span></div>${deleteButton}</div>${ratingSection}</div>`;
        }
        
        function renderMessage(data) {
            const isUser = data.sender === 'user';
            const isAdmin = data.sender === 'admin';
            const isAI = isAdmin && data.source === 'ai';
            const messageClass = isUser ? 'message-user' : 'message-admin';
            const containerClass = isUser ? 'self-start items-start' : 'self-end items-end';
            let senderName = '';
            if(isUser) senderName = telegramUserName;
            else if(isAI) senderName = 'Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯';
            else senderName = currentTicketData ? departmentMap[currentTicketData.department] || 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†' : 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†';

            const time = new Date(data.created_at).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit'});

            let content = '';
            if (data.type === 'image_placeholder') {
                content = `<div class="flex items-center gap-1 italic opacity-90"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg><span>ØªØµÙˆÛŒØ±</span></div>`;
            } else {
                if (data.text) content += `<p class="whitespace-pre-wrap leading-relaxed">${data.text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-brand-primary underline decoration-dotted underline-offset-2">$1</a>')}</p>`;
                if (data.imageUrl) content += `<a href="${data.imageUrl}" target="_blank" class="block mt-2"><img src="${data.imageUrl}" class="rounded-lg max-w-full border border-slate-200" loading="lazy"></a>`;
            }
            
            let aiBtn = '';
            if (isAI) {
                aiBtn = `<div class="mt-2 pt-2 border-t border-slate-100 w-full"><button class="request-human-btn w-full text-[10px] py-2 px-2 rounded-lg bg-slate-50 hover:bg-slate-100 active:bg-slate-200 text-slate-700 flex justify-center items-center gap-1 transition-colors border border-slate-200 font-medium" data-ticket-id="${currentTicketId}">Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ù¾Ø±Ø§ØªÙˆØ±</button></div>`;
            }
            return `<div class="flex flex-col ${containerClass} max-w-[85%] group animate-fade-in-up"><span class="text-[10px] text-slate-500 mb-1 px-1 opacity-80">${senderName}</span><div class="message-bubble ${messageClass}">${content}${aiBtn}</div><span class="text-[9px] text-slate-500 mt-1 px-1 opacity-70">${time}</span></div>`;
        }
        
        function appendMessageToUI(messageData) {
            conversationContainer.innerHTML += renderMessage(messageData);
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
        }

        function openConversation(ticketId) {
            currentTicketId = ticketId;
            currentTicketData = allTicketsData.find(t => t.id === ticketId);
            if (!currentTicketData) return showNotification("ÛŒØ§ÙØª Ù†Ø´Ø¯", false);
            conversationView.classList.remove('hidden');
            setTimeout(() => { conversationView.classList.add('is-open'); }, 50);
            conversationHeader.textContent = currentTicketData.subject;
            listenToMessages(ticketId);
            updateConversationViewUI();
        }

        function updateConversationViewUI() {
            if (currentTicketData && currentTicketData.status === 'closed') {
                replyBox.classList.add('hidden');
                closedTicketBanner.classList.remove('hidden');
            } else {
                replyBox.classList.remove('hidden');
                closedTicketBanner.classList.add('hidden');
            }
        }

        async function fetchMessages(ticketId) {
            if (!ticketId) return;
            try {
                const response = await fetch(`${WORKER_URL}/messages?ticket_id=${ticketId}`);
                if (!response.ok) return;
                const result = await response.json();
                if (result.success && result.data) {
                    const isBottom = conversationContainer.scrollHeight - conversationContainer.clientHeight <= conversationContainer.scrollTop + 150;
                    conversationContainer.innerHTML = Object.values(result.data).sort((a,b) => new Date(a.created_at) - new Date(b.created_at)).map(renderMessage).join('');
                    attachHumanRequestListeners();
                    if(isBottom) conversationContainer.scrollTop = conversationContainer.scrollHeight;
                }
            } catch (error) {}
        }

        function attachHumanRequestListeners() {
            document.querySelectorAll('.request-human-btn').forEach(button => {
                if (button.dataset.listenerAttached) return;
                button.dataset.listenerAttached = 'true';
                button.addEventListener('click', async (e) => {
                    const btn = e.currentTarget;
                    btn.disabled = true;
                    btn.innerText = '...';
                    try {
                        const response = await fetch(`${WORKER_URL}/tickets/${btn.dataset.ticketId}/request-human`, { method: 'POST' });
                        if (!response.ok) throw new Error();
                        showNotification('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øª Ø´Ø¯');
                        btn.innerText = 'âœ“';
                    } catch (error) {
                        btn.disabled = false;
                        btn.innerText = 'Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ù¾Ø±Ø§ØªÙˆØ±';
                    }
                });
            });
        }

        function listenToMessages(ticketId) {
            fetchMessages(ticketId);
            if (messagesPollingInterval) clearInterval(messagesPollingInterval);
            messagesPollingInterval = setInterval(() => fetchMessages(ticketId), 3000);
        }

        function closeConversation() {
            if (messagesPollingInterval) clearInterval(messagesPollingInterval);
            conversationView.classList.remove('is-open');
            setTimeout(() => {
                conversationView.classList.add('hidden');
                currentTicketId = null;
                conversationContainer.innerHTML = '';
            }, 300);
        }

        async function sendTextMessage(text) {
             if (!currentTicketId || !text) return;
             const payload = { ticket_id: currentTicketId, sender: 'user', text: text };
             appendMessageToUI({ ...payload, created_at: new Date().toISOString() });
             replyMessageInput.value = '';
             replyMessageInput.style.height = 'auto';
             try {
                 await fetch(`${WORKER_URL}/messages`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 fetchMessages(currentTicketId);
             } catch (error) { showNotification('Ø®Ø·Ø§', false); }
        }
        
        async function handleImageUpload(file) {
            if (!file) return;
            if (file.size > 50 * 1024 * 1024) return showNotification("Ø­Ø¬Ù… Ø²ÛŒØ§Ø¯", false);
            showNotification("Ø§Ø±Ø³Ø§Ù„...", true);
            try {
                const formData = new FormData();
                formData.append('ticket_id', currentTicketId);
                formData.append('sender', 'user');
                formData.append('image', file, file.name);
                const res = await fetch(`${WORKER_URL}/messages`, { method: 'POST', body: formData });
                if (!res.ok) throw new Error();
                appendMessageToUI({ ticket_id: currentTicketId, sender: 'user', type: 'image_placeholder', created_at: new Date().toISOString() });
                showNotification("Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯", true);
            } catch (error) { showNotification('Ø®Ø·Ø§', false); }
            fileUploadInput.value = '';
        }

        const handleNewTicketSubmit = async () => {
            if (isSubmitting) return;
            const subject = document.getElementById('subject').value.trim();
            const message = document.getElementById('message').value.trim();
            const department = document.getElementById('department').value;
            
            if (!subject || !message) return showNotification("Ù„Ø·ÙØ§ Ù¾Ø± Ú©Ù†ÛŒØ¯", false);
            
            if (!isAiChecked && message.length > 10) {
                aiPrecheckModal.classList.remove('hidden');
                aiPrecheckModal.classList.add('flex');
                return;
            }
            submitTicketInternal(subject, message, department);
        };

        const submitTicketInternal = async (subject, message, department) => {
            isSubmitting = true;
            submitNewTicketBtn.disabled = true;
            submitNewTicketBtn.innerText = '...';
            try {
                const res = await fetch(`${WORKER_URL}/tickets`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telegram_id: telegramUserId, user_name: telegramUserName, subject, department, message }) });
                if (!res.ok) throw new Error();
                newTicketForm.reset();
                showNotification('Ø«Ø¨Øª Ø´Ø¯');
                fetchTickets();
                setTimeout(() => showView('ticketsList'), 500);
            } catch (error) { showNotification('Ø®Ø·Ø§', false); }
            finally {
                isSubmitting = false;
                submitNewTicketBtn.disabled = false;
                submitNewTicketBtn.innerText = 'Ø§Ø±Ø³Ø§Ù„ ØªÛŒÚ©Øª';
                isAiChecked = false;
            }
        }

        async function fetchAIImprovement(department, subject, message) {
            const systemPrompt = `You are a helpful customer support assistant.
            Your task is to improve the user's ticket request.
            1.  Refine the 'subject' to be concise and descriptive.
            2.  Rewrite the 'message' to be polite, formal, and clear (Persian language).
            3.  Select the best 'department' from this list: ['general', 'technical', 'sales', 'marketing', 'ideas'] based on the content.
            Return ONLY a JSON object with keys: {"department": "...", "subject": "...", "message": "..."}. Do not include markdown formatting.`;

            const userPrompt = `Current Department: ${department}
            Current Subject: ${subject}
            Current Message: ${message}`;

            const makeRequest = async (baseUrl) => {
                const response = await fetch(`${baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GAP_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: AI_MODEL,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        temperature: 0.7
                    })
                });
                if (!response.ok) throw new Error('API Error');
                return await response.json();
            };

            function parseAIResponse(data) {
                const content = data.choices[0].message.content;
                const cleanContent = content.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(cleanContent);
            }

            try {
                try {
                    const data = await makeRequest(GAP_BASE_URL_PRIMARY);
                    return parseAIResponse(data);
                } catch (e) {
                    const data = await makeRequest(GAP_BASE_URL_BACKUP);
                    return parseAIResponse(data);
                }
            } catch (finalError) { throw finalError; }
        }

        const triggerAI = async () => {
            const currentDept = document.getElementById('department').value;
            const currentSubj = document.getElementById('subject').value.trim();
            const currentMsg = document.getElementById('message').value.trim();

            if (!currentMsg) return showNotification("Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª", false);

            aiAssistBtn.disabled = true;
            const originalBtnContent = aiAssistBtn.innerHTML;
            aiAssistBtn.innerHTML = `<span>...</span>`;

            try {
                const result = await fetchAIImprovement(currentDept, currentSubj, currentMsg);
                document.getElementById('ai-suggested-dept-text').textContent = departmentMap[result.department] || result.department;
                document.getElementById('ai-suggested-dept-value').value = result.department;
                document.getElementById('ai-suggested-subject').textContent = result.subject;
                document.getElementById('ai-suggested-message').textContent = result.message;
                aiModal.classList.remove('hidden');
                aiModal.classList.add('flex');
            } catch (error) { showNotification("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·", false); } 
            finally {
                aiAssistBtn.disabled = false;
                aiAssistBtn.innerHTML = originalBtnContent;
            }
        };

        aiAssistBtn.addEventListener('click', triggerAI);
        aiPrecheckYes.addEventListener('click', () => { aiPrecheckModal.classList.remove('flex'); aiPrecheckModal.classList.add('hidden'); triggerAI(); });
        aiPrecheckNo.addEventListener('click', () => { 
            aiPrecheckModal.classList.remove('flex'); aiPrecheckModal.classList.add('hidden');
            const subject = document.getElementById('subject').value.trim();
            const message = document.getElementById('message').value.trim();
            const department = document.getElementById('department').value;
            submitTicketInternal(subject, message, department);
        });
        aiRejectBtn.addEventListener('click', () => { aiModal.classList.remove('flex'); aiModal.classList.add('hidden'); });
        aiApplyBtn.addEventListener('click', () => {
            const newDept = document.getElementById('ai-suggested-dept-value').value;
            const newSubj = document.getElementById('ai-suggested-subject').textContent;
            const newMsg = document.getElementById('ai-suggested-message').textContent;
            
            const deptSelect = document.getElementById('department');
            for(let i=0; i<deptSelect.options.length; i++){
                if(deptSelect.options[i].value === newDept) {
                    deptSelect.selectedIndex = i;
                    break;
                }
            }
            document.getElementById('subject').value = newSubj;
            document.getElementById('message').value = newMsg;
            aiModal.classList.remove('flex');
            aiModal.classList.add('hidden');
            isAiChecked = true;
            showNotification("Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯", true);
        });
        
        document.getElementById('message').addEventListener('input', () => {
             if(document.getElementById('message').value.trim().length === 0) isAiChecked = false;
        });

        replyForm.addEventListener('submit', (e) => { e.preventDefault(); sendTextMessage(replyMessageInput.value.trim()); });
        attachFileBtn.addEventListener('click', () => { if (!currentTicketId) return; fileUploadInput.click(); });
        fileUploadInput.addEventListener('change', (e) => { if (e.target.files[0]) handleImageUpload(e.target.files[0]); });
        
        emojiBtn.addEventListener('click', (e) => { e.stopPropagation(); emojiPickerContainer.classList.toggle('hidden'); });
        emojiPicker.addEventListener('emoji-click', e => {
            const input = replyMessageInput;
            const text = input.value;
            const pos = input.selectionStart;
            input.value = text.slice(0, pos) + e.detail.unicode + text.slice(pos);
            input.focus();
            emojiPickerContainer.classList.add('hidden');
        });
        document.addEventListener('click', (e) => { if (!emojiPickerContainer.contains(e.target) && !emojiBtn.contains(e.target)) emojiPickerContainer.classList.add('hidden'); });
        
        replyMessageInput.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 80) + 'px'; });

        navButtons.ticketsList.addEventListener('click', () => showView('ticketsList'));
        navButtons.newTicket.addEventListener('click', () => { hasOpenTicket ? showModal('ØªÛŒÚ©Øª Ø¨Ø§Ø² Ø¯Ø§Ø±ÛŒØ¯', 'Ù„Ø·ÙØ§ ØµØ¨Ø± Ú©Ù†ÛŒØ¯', true) : (infoModal.classList.remove('hidden'), infoModal.classList.add('flex')); });

        backToTicketsBtn.addEventListener('click', closeConversation);
        newTicketForm.addEventListener('submit', (e) => { e.preventDefault(); handleNewTicketSubmit(); });
        submitNewTicketBtn.addEventListener('click', handleNewTicketSubmit);
        infoModalCloseBtn.addEventListener('click', () => { infoModal.classList.add('hidden'); infoModal.classList.remove('flex'); showView('newTicket'); });

        const faqButton = document.getElementById('faq-button');
        if (faqButton) faqButton.addEventListener('click', () => { const url = 'https://faqhub.amiruserbot7.workers.dev/'; window.Telegram?.WebApp ? window.Telegram.WebApp.openLink(url) : window.open(url); });
        
        document.getElementById('faq-link-modal')?.addEventListener('click', () => { const url = 'https://faqhub.amiruserbot7.workers.dev/'; window.Telegram?.WebApp ? window.Telegram.WebApp.openLink(url) : window.open(url); });
    </script>
</body>
</html>